name: compile_from_source

on:
  workflow_dispatch:

concurrency:
  group: compile_from_source-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    env:
      DEVICE: oriole
      KERNEL_BRANCH: android14-gs-pixel-6.1
      MANIFEST_URL: https://android.googlesource.com/kernel/manifest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps + repo
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc \
            bison \
            build-essential \
            ca-certificates \
            ccache \
            clang \
            cpio \
            curl \
            file \
            flex \
            git \
            lld \
            llvm \
            libelf-dev \
            make \
            ninja-build \
            openssl \
            pahole \
            pkg-config \
            python3 \
            python3-pip \
            rsync \
            unzip \
            xz-utils \
            zstd \
            zip \
            binutils \
            binutils-dev \
            openjdk-17-jdk-headless

          sudo install -d -m 0755 /usr/local/bin
          sudo curl -fsSL -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod 0755 /usr/local/bin/repo
          /usr/local/bin/repo version

      - name: Cache repo + ccache
        uses: actions/cache@v4
        with:
          path: |
            android-kernel/.repo
            .ccache
          key: pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-${{ hashFiles('.github/workflows/compile_from_source.yml') }}
          restore-keys: |
            pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-

      - name: repo init + sync
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/android-kernel"
          cd "${GITHUB_WORKSPACE}/android-kernel"

          if [ ! -d ".repo" ]; then
            /usr/local/bin/repo init -u "${MANIFEST_URL}" -b "${KERNEL_BRANCH}"
          fi

          /usr/local/bin/repo sync \
            -c \
            -j"$(nproc)" \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --prune

      - name: Patch gki_defconfig (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          DEFCONFIG_PATH="$(find ./common -type f -path '*/arch/arm64/configs/gki_defconfig' -print -quit)"
          if [ -z "${DEFCONFIG_PATH}" ]; then
            echo "ERROR: gki_defconfig not found under ./common" >&2
            exit 1
          fi
          echo "Using defconfig: ${DEFCONFIG_PATH}"

          ensure() {
            local key="$1" val="$2" f="$3"
            if grep -qE "^${key}=" "$f"; then
              sed -i "s/^${key}=.*/${key}=${val}/" "$f"
            else
              printf '%s=%s\n' "$key" "$val" >> "$f"
            fi
          }

          ensure CONFIG_BT_HCI y "${DEFCONFIG_PATH}"
          ensure CONFIG_BT_HCIBTUSB y "${DEFCONFIG_PATH}"
          ensure CONFIG_USB y "${DEFCONFIG_PATH}"
          ensure CONFIG_USB_SUPPORT y "${DEFCONFIG_PATH}"

          tail -n 40 "${DEFCONFIG_PATH}"

      - name: Prepare vendor ramdisk symlinks (optional; never fail)
        shell: bash
        run: |
          set -euo pipefail

          RAMDISK_DIR="${GITHUB_WORKSPACE}/android-kernel/prebuilts/boot-artifacts/ramdisks"
          mkdir -p "${RAMDISK_DIR}/vendor_ramdisk"

          if [ -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" ]; then
            cp -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" "${RAMDISK_DIR}/vendor_ramdisk-oriole.img"
            ln -sf "vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/oriole.img"
            ln -sf "../vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/vendor_ramdisk/oriole.img"
          fi

          /usr/bin/ls -al "${RAMDISK_DIR}" || true
          /usr/bin/ls -al "${RAMDISK_DIR}/vendor_ramdisk" || true

      - name: Build with Kleaf (public targets only)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          mkdir -p "${GITHUB_WORKSPACE}/.ccache"
          ccache --set-config=max_size=5.0G
          export USE_CCACHE=1
          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache"

          if [ ! -x "./tools/bazel" ]; then
            echo "ERROR: tools/bazel not found or not executable." >&2
            /usr/bin/ls -al ./tools >&2 || true
            exit 1
          fi

          # IMPORTANT: keep Bazel outputs OUTSIDE the repo workspace
          BAZEL_USER_ROOT="/tmp/bazel_user_root_${GITHUB_RUN_ID}"
          BAZEL="./tools/bazel --output_user_root=${BAZEL_USER_ROOT}"

          echo "Using Bazel output_user_root: ${BAZEL_USER_ROOT}"

          # Prefer known common dist targets; fall back to searching under //common/...
          pick=""

          for c in \
            "//common:kernel_aarch64_dist" \
            "//common:kernel_aarch64_gki_dist" \
            "//common:kernel_aarch64_gki_debug_dist" \
            "//common:kernel_aarch64_gki_kasan_dist" \
            "//common:kernel_aarch64_gki_kprobes_dist"
          do
            if ${BAZEL} query "${c}" >/dev/null 2>&1; then
              pick="${c}"
              break
            fi
          done

          if [ -z "${pick}" ]; then
            echo "Listing *_dist under //common/... (this repo has no //private/gs-google)..."
            ${BAZEL} query 'attr(name, ".*_dist$", //common/...)' | tee "${GITHUB_WORKSPACE}/dist_targets.txt"
            # Prefer aarch64 if present
            pick="$(grep -E 'aarch64.*_dist$' "${GITHUB_WORKSPACE}/dist_targets.txt" | head -n 1 || true)"
            if [ -z "${pick}" ]; then
              pick="$(head -n 1 "${GITHUB_WORKSPACE}/dist_targets.txt" || true)"
            fi
          fi

          if [ -z "${pick}" ]; then
            echo "ERROR: no *_dist targets found under //common/..." >&2
            exit 1
          fi

          echo "Chosen dist target: ${pick}"
          echo "${pick}" > "${GITHUB_WORKSPACE}/chosen_dist_target.txt"

          ${BAZEL} run "${pick}" 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"

      - name: Collect dist output
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/dist"

          echo "Searching for dist directories..."
          mapfile -t dists < <(find "${GITHUB_WORKSPACE}/android-kernel" -maxdepth 8 -type d -name dist 2>/dev/null || true)

          if [ "${#dists[@]}" -eq 0 ]; then
            echo "No dist directories found."
          else
            for d in "${dists[@]}"; do
              echo "Copying: ${d}"
              rsync -a "${d}/." "${GITHUB_WORKSPACE}/dist/" || true
            done
          fi

          echo "dist contents:"
          /usr/bin/ls -al "${GITHUB_WORKSPACE}/dist" || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ env.DEVICE }}
          path: |
            dist/**
            build.log
            dist_targets.txt
            chosen_dist_target.txt
          if-no-files-found: warn
