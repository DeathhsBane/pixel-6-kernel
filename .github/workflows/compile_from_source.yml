name: Pixel 6 Kernel (oriole) â€” fast, repeatable CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "android-kernel/**"
      - ".github/workflows/pixel6-kernel.yml"

concurrency:
  group: pixel6-kernel-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    env:
      DEVICE: oriole
      KERNEL_TOP: /home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel
      RAMDISK_DIR: /home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel/prebuilts/boot-artifacts/ramdisks
      VENDOR_BOOT_IMG: /home/runner/work/pixel-6-kernel/pixel-6-kernel/prebuilts/vendor_boot-oriole.img

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps (fix ld.bfd + host toolchain)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bash \
            bc \
            bison \
            build-essential \
            ca-certificates \
            clang \
            cpio \
            curl \
            flex \
            gcc \
            git \
            g++ \
            lld \
            llvm \
            make \
            ninja-build \
            openssl \
            pahole \
            pkg-config \
            python3 \
            python3-pip \
            rsync \
            unzip \
            xz-utils \
            zstd \
            binutils \
            binutils-dev \
            file

          command -v ld.bfd >/dev/null 2>&1 || true
          command -v ld >/dev/null 2>&1
          command -v gcc >/dev/null 2>&1

      - name: Install repo (writable launcher)
        shell: bash
        run: |
          set -euo pipefail
          sudo install -d -m 0755 /usr/local/bin
          sudo curl -fsSL -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod 0755 /usr/local/bin/repo
          /usr/local/bin/repo version

      - name: Cache repo + out (huge speedup)
        uses: actions/cache@v4
        with:
          path: |
            android-kernel/.repo
            android-kernel/out
          key: pixel6-kernel-${{ runner.os }}-${{ hashFiles('android-kernel/.repo/manifest.xml', 'android-kernel/.repo/manifests/**', 'android-kernel/.repo/manifests.git/**') }}
          restore-keys: |
            pixel6-kernel-${{ runner.os }}-

      - name: repo sync (fast flags)
        shell: bash
        run: |
          set -euo pipefail
          cd /home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel

          if [ ! -d "/home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel/.repo" ]; then
            echo "ERROR: android-kernel/.repo missing. Commit your repo init state, or add an init step here." >&2
            exit 1
          fi

          /usr/local/bin/repo sync \
            -c \
            -j"$(nproc)" \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --prune

      - name: Find + patch gki_defconfig (robust path)
        shell: bash
        run: |
          set -euo pipefail
          cd /home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel

          echo "Searching for gki_defconfig..."
          DEFCONFIG_PATH="$(find ./aosp ./common -type f -path "*/arch/arm64/configs/gki_defconfig" -print -quit || true)"
          if [ -z "${DEFCONFIG_PATH}" ]; then
            echo "ERROR: gki_defconfig not found under ./aosp or ./common" >&2
            find . -maxdepth 4 -type f -name "gki_defconfig" -print || true
            exit 1
          fi
          echo "Using defconfig: ${DEFCONFIG_PATH}"

          echo "" >> "${DEFCONFIG_PATH}"
          echo "CONFIG_BT_HCI=y" >> "${DEFCONFIG_PATH}"
          echo "CONFIG_BT_HCIBTUSB=y" >> "${DEFCONFIG_PATH}"
          echo "CONFIG_USB=y" >> "${DEFCONFIG_PATH}"
          echo "CONFIG_USB_SUPPORT=y" >> "${DEFCONFIG_PATH}"

          echo "Patched tail of defconfig:"
          tail -n 40 "${DEFCONFIG_PATH}"

      - name: Prepare vendor ramdisk (no more missing file failures)
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "/home/runner/work/pixel-6-kernel/pixel-6-kernel/prebuilts/vendor_boot-oriole.img" ]; then
            echo "ERROR: Missing vendor boot image at:" >&2
            echo "  /home/runner/work/pixel-6-kernel/pixel-6-kernel/prebuilts/vendor_boot-oriole.img" >&2
            echo "" >&2
            echo "Put your Pixel 6 vendor_boot.img there (commit it or download it in a prior step)." >&2
            exit 1
          fi

          rm -rf /home/runner/work/pixel-6-kernel/pixel-6-kernel/vendor_boot_out
          mkdir -p /home/runner/work/pixel-6-kernel/pixel-6-kernel/vendor_boot_out

          python3 - <<'PY'
import os, sys, subprocess, shutil, pathlib

top = pathlib.Path("/home/runner/work/pixel-6-kernel/pixel-6-kernel")
vendor_boot = top / "prebuilts" / "vendor_boot-oriole.img"
outdir = top / "vendor_boot_out"
ramdisks = pathlib.Path("/home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel/prebuilts/boot-artifacts/ramdisks")

ramdisks.mkdir(parents=True, exist_ok=True)
(outdir).mkdir(parents=True, exist_ok=True)

unpack = top / "android-kernel" / "build" / "kernel" / "build-tools" / "path" / "linux-x86" / "unpack_bootimg"
if not unpack.exists():
    # fallback: try to use any unpack_bootimg in PATH
    unpack = shutil.which("unpack_bootimg")
    if not unpack:
        print("ERROR: unpack_bootimg not found (build-tools/path or PATH).", file=sys.stderr)
        sys.exit(1)

cmd = [str(unpack), "--boot_img", str(vendor_boot), "--out", str(outdir)]
subprocess.check_call(cmd)

# AOSP unpack_bootimg for vendor_boot v4 writes vendor ramdisks into vendor-ramdisk-by-name/
byname = outdir / "vendor-ramdisk-by-name"
if not byname.exists():
    print(f"ERROR: expected {byname} not found after unpack.", file=sys.stderr)
    sys.exit(1)

# Find the first vendor ramdisk file (ramdisk_*). Keep behavior aligned with your logs.
cands = sorted([p for p in byname.iterdir() if p.is_file() and p.name.startswith("ramdisk")])
if not cands:
    print(f"ERROR: no vendor ramdisk blobs found in {byname}", file=sys.stderr)
    sys.exit(1)

src = cands[0]
dst = ramdisks / "vendor_ramdisk-oriole.img"

# Replace with a real file (not symlink) to keep kernel scripts happy
if dst.exists() or dst.is_symlink():
    dst.unlink()
shutil.copy2(src, dst)

# Create the exact symlinks your tree expects (matches your logs)
for link in [
    ramdisks / "oriole.img",
]:
    if link.exists() or link.is_symlink():
        link.unlink()
    link.symlink_to(dst.name)

nested = ramdisks / "vendor_ramdisk"
nested.mkdir(parents=True, exist_ok=True)
nested_link = nested / "oriole.img"
if nested_link.exists() or nested_link.is_symlink():
    nested_link.unlink()
nested_link.symlink_to(pathlib.Path("..") / dst.name)

print("ramdisks dir:")
subprocess.check_call(["/usr/bin/ls", "-al", str(ramdisks)])
print("vendor_ramdisk dir:")
subprocess.check_call(["/usr/bin/ls", "-al", str(nested)])
PY

          test -f "/home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk-oriole.img"
          test -e "/home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel/prebuilts/boot-artifacts/ramdisks/oriole.img"
          test -e "/home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk/oriole.img"

      - name: Build (force host tools to use system gcc/binutils)
        shell: bash
        run: |
          set -euo pipefail
          cd /home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel

          export HOSTCC=/usr/bin/gcc
          export HOSTCXX=/usr/bin/g++
          export HOSTLD=/usr/bin/ld.bfd
          export HOSTCFLAGS="-std=gnu11"
          export HOSTCXXFLAGS="-std=gnu++17"

          ./build_slider.sh | tee /tmp/build.log

      - name: Collect dist output
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          cd /home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel
          echo "dist:"
          ls -al /home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel/out/mixed/dist || true
          echo "last 200 lines build.log:"
          tail -n 200 /tmp/build.log || true

      - name: Upload dist artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ env.DEVICE }}
          path: |
            android-kernel/out/mixed/dist/**
            /tmp/build.log
          if-no-files-found: warn
