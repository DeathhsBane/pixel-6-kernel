name: Pixel 6 Kernel (oriole) â€” fast, repeatable CI

on:
  workflow_dispatch:
    inputs:
      factory_zip:
        description: "Pixel 6 (oriole) factory zip filename (from Google factory images)"
        required: true
        default: "oriole-ap2a.240905.003.f1-factory-655c44e7.zip"
  push:
    branches:
      - main
    paths:
      - "android-kernel/**"
      - ".github/workflows/pixel6-kernel.yml"

concurrency:
  group: pixel6-kernel-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    env:
      DEVICE: oriole
      KERNEL_TOP: /home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel
      RAMDISK_DIR: /home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel/prebuilts/boot-artifacts/ramdisks
      FACTORY_BASE_URL: https://dl.google.com/dl/android/aosp

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps (binutils/ld.bfd + host toolchain)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bash bc bison build-essential ca-certificates clang cpio curl flex \
            gcc g++ git lld llvm make ninja-build openssl pahole pkg-config \
            python3 python3-pip rsync unzip xz-utils zstd \
            binutils binutils-dev file

          command -v /usr/bin/ld.bfd >/dev/null 2>&1
          /usr/bin/ld.bfd --version | head -n 1 || true

      - name: Install repo (writable launcher)
        shell: bash
        run: |
          set -euo pipefail
          sudo install -d -m 0755 /usr/local/bin
          sudo curl -fsSL -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod 0755 /usr/local/bin/repo
          /usr/local/bin/repo version

      - name: Cache repo + out (huge speedup)
        uses: actions/cache@v4
        with:
          path: |
            android-kernel/.repo
            android-kernel/out
          key: pixel6-kernel-${{ runner.os }}-${{ hashFiles('android-kernel/.repo/manifest.xml', 'android-kernel/.repo/manifests/**', 'android-kernel/.repo/manifests.git/**') }}
          restore-keys: |
            pixel6-kernel-${{ runner.os }}-

      - name: repo sync (fast flags)
        shell: bash
        run: |
          set -euo pipefail
          cd "${KERNEL_TOP}"

          if [ ! -d "${KERNEL_TOP}/.repo" ]; then
            echo "ERROR: android-kernel/.repo missing. Commit your repo init state, or add an init step." >&2
            exit 1
          fi

          /usr/local/bin/repo sync \
            -c \
            -j"$(nproc)" \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --prune

      - name: Find + patch gki_defconfig (robust path)
        shell: bash
        run: |
          set -euo pipefail
          cd "${KERNEL_TOP}"

          echo "Searching for gki_defconfig..."
          DEFCONFIG_PATH="$(find ./aosp ./common -type f -path "*/arch/arm64/configs/gki_defconfig" -print -quit || true)"
          if [ -z "${DEFCONFIG_PATH}" ]; then
            echo "ERROR: gki_defconfig not found under ./aosp or ./common" >&2
            find . -maxdepth 6 -type f -name "gki_defconfig" -print || true
            exit 1
          fi
          echo "Using defconfig: ${DEFCONFIG_PATH}"

          {
            echo ""
            echo "CONFIG_BT_HCI=y"
            echo "CONFIG_BT_HCIBTUSB=y"
            echo "CONFIG_USB=y"
            echo "CONFIG_USB_SUPPORT=y"
          } >> "${DEFCONFIG_PATH}"

          echo "Patched tail of defconfig:"
          tail -n 40 "${DEFCONFIG_PATH}"

      - name: Download factory zip + extract vendor_boot.img
        shell: bash
        run: |
          set -euo pipefail

          FACTORY_ZIP="${{ github.event.inputs.factory_zip || 'oriole-ap2a.240905.003.f1-factory-655c44e7.zip' }}"
          echo "Factory zip: ${FACTORY_ZIP}"

          mkdir -p /home/runner/work/pixel-6-kernel/pixel-6-kernel/prebuilts
          cd /home/runner/work/pixel-6-kernel/pixel-6-kernel/prebuilts

          if [ ! -f "${FACTORY_ZIP}" ]; then
            curl -fL --retry 5 --retry-delay 2 -o "${FACTORY_ZIP}" "${FACTORY_BASE_URL}/${FACTORY_ZIP}"
          fi

          rm -f vendor_boot-oriole.img
          unzip -p "${FACTORY_ZIP}" "vendor_boot.img" > vendor_boot-oriole.img

          test -s vendor_boot-oriole.img
          ls -al vendor_boot-oriole.img

      - name: Prepare vendor ramdisk (create vendor_ramdisk-oriole.img)
        shell: bash
        run: |
          set -euo pipefail

          TOP="/home/runner/work/pixel-6-kernel/pixel-6-kernel"
          VENDOR_BOOT="${TOP}/prebuilts/vendor_boot-oriole.img"
          OUTDIR="${TOP}/vendor_boot_out"
          RAMDISKS="${RAMDISK_DIR}"
          DEVICE="${DEVICE}"

          rm -rf "${OUTDIR}"
          mkdir -p "${OUTDIR}"
          mkdir -p "${RAMDISKS}"

          python3 - <<'PY'
          import os, sys, subprocess, shutil, pathlib
          
          TOP = pathlib.Path("/home/runner/work/pixel-6-kernel/pixel-6-kernel")
          VENDOR_BOOT = TOP / "prebuilts" / "vendor_boot-oriole.img"
          OUTDIR = TOP / "vendor_boot_out"
          RAMDISKS = pathlib.Path("/home/runner/work/pixel-6-kernel/pixel-6-kernel/android-kernel/prebuilts/boot-artifacts/ramdisks")
          DEVICE = os.environ.get("DEVICE", "oriole")
          
          RAMDISKS.mkdir(parents=True, exist_ok=True)
          OUTDIR.mkdir(parents=True, exist_ok=True)
          
          unpack = TOP / "android-kernel" / "build" / "kernel" / "build-tools" / "path" / "linux-x86" / "unpack_bootimg"
          if not unpack.exists():
              alt = shutil.which("unpack_bootimg")
              if not alt:
                  print("ERROR: unpack_bootimg not found (build-tools/path or PATH).", file=sys.stderr)
                  sys.exit(1)
              unpack = pathlib.Path(alt)
          
          subprocess.check_call([str(unpack), "--boot_img", str(VENDOR_BOOT), "--out", str(OUTDIR)])
          
          byname = OUTDIR / "vendor-ramdisk-by-name"
          if not byname.exists():
              print(f"ERROR: expected {byname} not found after unpack.", file=sys.stderr)
              sys.exit(1)
          
          cands = sorted([p for p in byname.iterdir() if p.is_file() and p.name.startswith("ramdisk")])
          if not cands:
              print(f"ERROR: no vendor ramdisk blobs found in {byname}", file=sys.stderr)
              sys.exit(1)
          
          src = cands[0]
          dst = RAMDISKS / f"vendor_ramdisk-{DEVICE}.img"
          
          if dst.exists() or dst.is_symlink():
              dst.unlink()
          shutil.copy2(src, dst)
          
          top_link = RAMDISKS / f"{DEVICE}.img"
          if top_link.exists() or top_link.is_symlink():
              top_link.unlink()
          top_link.symlink_to(dst.name)
          
          nested = RAMDISKS / "vendor_ramdisk"
          nested.mkdir(parents=True, exist_ok=True)
          nested_link = nested / f"{DEVICE}.img"
          if nested_link.exists() or nested_link.is_symlink():
              nested_link.unlink()
          nested_link.symlink_to(pathlib.Path("..") / dst.name)
          
          print("ramdisks dir:")
          subprocess.check_call(["/usr/bin/ls", "-al", str(RAMDISKS)])
          print("vendor_ramdisk dir:")
          subprocess.check_call(["/usr/bin/ls", "-al", str(nested)])
          PY
          
                    FOUND=0
                    for p in \
                      "${RAMDISK_DIR}/vendor_ramdisk-${DEVICE}.img" \
                      "${RAMDISK_DIR}/${DEVICE}.img" \
                      "${RAMDISK_DIR}/vendor_ramdisk/${DEVICE}.img"
                    do
                      if [ -e "${p}" ]; then
                        echo "OK: found ${p}"
                        FOUND=1
                      else
                        echo "MISS: ${p}"
                      fi
                    done
          
                    if [ "${FOUND}" -ne 1 ]; then
                      echo "ERROR: vendor ramdisk not found in any expected location." >&2
                      exit 1
                    fi
          
                - name: Build (force host tools to use system gcc/binutils)
                  shell: bash
                  run: |
                    set -euo pipefail
                    cd "${KERNEL_TOP}"
          
                    export HOSTCC=/usr/bin/gcc
                    export HOSTCXX=/usr/bin/g++
                    export HOSTLD=/usr/bin/ld.bfd
                    export HOSTCFLAGS="-std=gnu11"
                    export HOSTCXXFLAGS="-std=gnu++17"
          
                    ./build_slider.sh | tee /tmp/build.log
          
                - name: Collect dist output
                  if: always()
                  shell: bash
                  run: |
                    set -euo pipefail
                    cd "${KERNEL_TOP}"
                    echo "dist:"
                    ls -al "${KERNEL_TOP}/out/mixed/dist" || true
                    echo "last 200 lines build.log:"
                    tail -n 200 /tmp/build.log || true
          
                - name: Upload dist artifacts
                  if: always()
                  uses: actions/upload-artifact@v4
                  with:
                    name: dist-${{ env.DEVICE }}
                    path: |
                      android-kernel/out/mixed/dist/**
                      /tmp/build.log
                    if-no-files-found: warn
