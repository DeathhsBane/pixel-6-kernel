name: compile_from_source

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - ".github/workflows/compile_from_source.yml"

concurrency:
  group: compile_from_source-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    env:
      DEVICE: oriole
      KERNEL_BRANCH: android14-gs-pixel-6.1
      MANIFEST_URL: https://android.googlesource.com/kernel/manifest
      BUILD_CONFIG: common/build.config.gki.aarch64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ca-certificates clang cpio curl flex gcc g++ git \
            lld llvm make ninja-build openssl pahole pkg-config python3 python3-pip \
            rsync unzip xz-utils zstd binutils binutils-dev file lz4 ccache libelf-dev

      - name: Install repo tool
        shell: bash
        run: |
          set -euo pipefail
          sudo install -d -m 0755 /usr/local/bin
          sudo curl -fsSL -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod 0755 /usr/local/bin/repo
          /usr/local/bin/repo version

      - name: Cache repo + out
        uses: actions/cache@v4
        with:
          path: |
            android-kernel/.repo
            android-kernel/out
          key: pixel6-kernel-${{ runner.os }}-${{ env.KERNEL_BRANCH }}
          restore-keys: |
            pixel6-kernel-${{ runner.os }}-

      - name: repo init + sync
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "${GITHUB_WORKSPACE}/android-kernel"
          cd "${GITHUB_WORKSPACE}/android-kernel"

          if [ ! -d ".repo" ]; then
            /usr/local/bin/repo init -u "${MANIFEST_URL}" -b "${KERNEL_BRANCH}"
          fi

          /usr/local/bin/repo sync \
            -c \
            -j"$(nproc)" \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --prune

      - name: Patch gki_defconfig (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          DEFCONFIG="./common/arch/arm64/configs/gki_defconfig"
          test -f "${DEFCONFIG}"

          ensure_line() {
            local line="$1"
            grep -qxF "${line}" "${DEFCONFIG}" || echo "${line}" >> "${DEFCONFIG}"
          }

          ensure_line ""
          ensure_line "CONFIG_BT_HCI=y"
          ensure_line "CONFIG_BT_HCIBTUSB=y"
          ensure_line "CONFIG_USB=y"
          ensure_line "CONFIG_USB_SUPPORT=y"

          echo "Tail of ${DEFCONFIG}:"
          tail -n 40 "${DEFCONFIG}"

      - name: Ensure vendor ramdisk file exists (use repo-root vendor_ramdisk00 if present)
        shell: bash
        run: |
          set -euo pipefail
          RAMDISK_DIR="${GITHUB_WORKSPACE}/android-kernel/prebuilts/boot-artifacts/ramdisks"
          mkdir -p "${RAMDISK_DIR}/vendor_ramdisk"

          if [ -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" ]; then
            cp -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" "${RAMDISK_DIR}/vendor_ramdisk-oriole.img"
          fi

          test -f "${RAMDISK_DIR}/vendor_ramdisk-oriole.img"

          ln -sf "vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/oriole.img"
          ln -sf "../vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/vendor_ramdisk/oriole.img"

          ls -al "${RAMDISK_DIR}"
          ls -al "${RAMDISK_DIR}/vendor_ramdisk"

      - name: Build kernel (use real build.sh)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          BUILD_SH=""
          if [ -x "./build/build.sh" ]; then
            BUILD_SH="./build/build.sh"
          elif [ -x "./build/kernel/build.sh" ]; then
            BUILD_SH="./build/kernel/build.sh"
          fi

          if [ -z "${BUILD_SH}" ]; then
            echo "ERROR: build.sh not found at ./build/build.sh or ./build/kernel/build.sh" >&2
            find . -maxdepth 4 -type f -name "build.sh" -print || true
            exit 1
          fi

          echo "Using build script: ${BUILD_SH}"
          echo "Using BUILD_CONFIG: ${BUILD_CONFIG}"

          export BUILD_CONFIG="${BUILD_CONFIG}"
          "${BUILD_SH}" 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"

      - name: Collect outputs
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "Dist dirs:"
          find "${GITHUB_WORKSPACE}/android-kernel/out" -type d -name "dist" -print || true
          echo "Last 200 lines of build.log:"
          tail -n 200 "${GITHUB_WORKSPACE}/build.log" || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oriole-build
          path: |
            android-kernel/out/**/dist/**
            build.log
          if-no-files-found: warn

