name: Compile Pixel 6 Kernel (BTUSB enabled)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/compile_from_source.yml"
      - "vendor_ramdisk00"
      - "flash-all.bat"
      - "flash-all.sh"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      KERNEL_BRANCH: android14-gs-pixel-6.1
      DEVICE: oriole
      FACTORY_IMAGE: oriole-ap2a.240905.003.f1
      FACTORY_ZIP: oriole-ap2a.240905.003.f1-factory-655c44e7.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Install build dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            git curl unzip zip python3 python3-pip \
            build-essential bc bison flex \
            libssl-dev libelf-dev libncurses-dev \
            clang lld llvm \
            binutils binutils-dev \
            dwarves zstd xz-utils \
            rsync ca-certificates

      - name: Install repo tool
        run: |
          set -euo pipefail
          sudo curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod 0755 /usr/local/bin/repo
          repo --version || true

      - name: Sync kernel repo
        run: |
          set -euo pipefail
          mkdir -p android-kernel
          cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b "${KERNEL_BRANCH}"
          repo sync -c --no-tags --no-clone-bundle --optimized-fetch --prune -j"$(nproc)"

      - name: Locate and patch GKI defconfig (auto-detect)
        run: |
          set -euo pipefail
          cd android-kernel

          echo "Searching for gki_defconfig..."
          DEFCONFIG="$(find . -type f -path "*/arch/arm64/configs/gki_defconfig" -o -path "*/common/arch/arm64/configs/gki_defconfig" 2>/dev/null | head -n 1 || true)"

          if [ -z "${DEFCONFIG}" ]; then
            echo "ERROR: Could not find gki_defconfig in tree."
            echo "Here are likely config directories:"
            find . -maxdepth 4 -type d -name configs -print || true
            exit 1
          fi

          echo "Using defconfig: ${DEFCONFIG}"

          grep -q '^CONFIG_BT_HCI=y' "${DEFCONFIG}" || echo 'CONFIG_BT_HCI=y' >> "${DEFCONFIG}"
          grep -q '^CONFIG_BT_HCIBTUSB=y' "${DEFCONFIG}" || echo 'CONFIG_BT_HCIBTUSB=y' >> "${DEFCONFIG}"
          grep -q '^CONFIG_USB=y' "${DEFCONFIG}" || echo 'CONFIG_USB=y' >> "${DEFCONFIG}"
          grep -q '^CONFIG_USB_SUPPORT=y' "${DEFCONFIG}" || echo 'CONFIG_USB_SUPPORT=y' >> "${DEFCONFIG}"

          echo "Patched tail of defconfig:"
          tail -n 25 "${DEFCONFIG}"

      - name: Download factory image and extract vendor_boot
        run: |
          set -euo pipefail
          curl -L -o "${FACTORY_ZIP}" "https://dl.google.com/dl/android/aosp/${FACTORY_ZIP}"
          unzip -q "${FACTORY_ZIP}"
          cd "${FACTORY_IMAGE}"
          unzip -q "image-${FACTORY_IMAGE}.zip" vendor_boot.img
          mv vendor_boot.img ..
          cd ..

      - name: Extract vendor ramdisk and place where build expects it
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"

          python3 android-kernel/tools/mkbootimg/unpack_bootimg.py \
            --boot_img vendor_boot.img \
            --out vendor_boot_out

          VENDOR_RAMDISK_SRC="vendor_boot_out/vendor-ramdisk-by-name/ramdisk_"

          mkdir -p android-kernel/prebuilts/boot-artifacts/ramdisks
          mkdir -p android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk

          cp -f "${VENDOR_RAMDISK_SRC}" "android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk-${DEVICE}.img"

          ln -sf "../vendor_ramdisk-${DEVICE}.img" "android-kernel/prebuilts/boot-artifacts/ramdisks/${DEVICE}.img"
          ln -sf "../vendor_ramdisk-${DEVICE}.img" "android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk/${DEVICE}.img"

      - name: Sanity check vendor ramdisk exists
        run: |
          set -euo pipefail
          ls -al android-kernel/prebuilts/boot-artifacts/ramdisks
          ls -al android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk || true
          test -e "android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk-${DEVICE}.img"
          test -e "android-kernel/prebuilts/boot-artifacts/ramdisks/${DEVICE}.img"
          test -e "android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk/${DEVICE}.img"

      - name: Build (bazel fast config)
        run: |
          set -euo pipefail
          cd android-kernel
          tools/bazel run --config=fast --config=stamp //private/google-modules/soc/gs:slider_dist

      - name: Pack images
        run: |
          set -euo pipefail
          mkdir -p images
          cp android-kernel/out/slider/dist/boot.img images/
          cp android-kernel/out/slider/dist/dtbo.img images/
          cp android-kernel/out/slider/dist/vendor_boot.img images/
          cp android-kernel/out/slider/dist/vendor_dlkm.img images/
          cp -f flash-all.sh images/ || true
          cp -f flash-all.bat images/ || true
          zip -r images.zip images

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: the-images
          path: images.zip
