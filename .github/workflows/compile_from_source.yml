name: Compile Kernel from Source

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/compile_from_source.yml"
      - "vendor_ramdisk00"
      - "flash-all.bat"
      - "flash-all.sh"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      FACTORY_IMAGE: oriole-ap2a.240905.003.f1
      FACTORY_ZIP_URL: https://dl.google.com/dl/android/aosp/oriole-ap2a.240905.003.f1-factory-655c44e7.zip

    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Free up space
        uses: jlumbroso/free-disk-space@main
        
      - name: Install packages
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            repo git curl unzip zip python3 python3-pip \
            bc bison flex make rsync \
            libssl-dev libelf-dev dwarves \
            gcc clang lld \
            build-essential \
            ca-certificates


      - name: Sync kernel repo
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p android-kernel
          cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b android-gs-raviole-5.10-android14
          repo sync -c --no-tags -j1 --fail-fast --force-sync --no-clone-bundle

      - name: Force-enable BT USB (ASUS BT500) in defconfig
        shell: bash
        run: |
          set -euo pipefail
          cd android-kernel

          DEF="$(find . -type f -name gki_defconfig | head -n 1)"
          if [ -z "${DEF}" ]; then
            echo "ERROR: gki_defconfig not found" >&2
            exit 1
          fi

          echo "[+] Using defconfig: ${DEF}"
          cp -av "${DEF}" "${DEF}.bak"

          # Ensure Bluetooth core + USB HCI dongle support (btusb)
          grep -q '^CONFIG_BT=' "${DEF}" || echo 'CONFIG_BT=y' >> "${DEF}"
          grep -q '^CONFIG_BT_HCI=' "${DEF}" || echo 'CONFIG_BT_HCI=y' >> "${DEF}"
          grep -q '^CONFIG_BT_RFCOMM=' "${DEF}" || echo 'CONFIG_BT_RFCOMM=y' >> "${DEF}"
          grep -q '^CONFIG_BT_HCIBTUSB=' "${DEF}" || echo 'CONFIG_BT_HCIBTUSB=y' >> "${DEF}"

          # Ensure USB stack basics are on (usually already)
          grep -q '^CONFIG_USB=' "${DEF}" || echo 'CONFIG_USB=y' >> "${DEF}"
          grep -q '^CONFIG_USB_SUPPORT=' "${DEF}" || echo 'CONFIG_USB_SUPPORT=y' >> "${DEF}"

          echo "----- tail ${DEF} -----"
          tail -n 60 "${DEF}"

      - name: Update vendor ramdisk (through curl)
        shell: bash
        run: |
          set -euo pipefail

          curl -fL -o factory.zip "${FACTORY_ZIP_URL}"
          unzip -q factory.zip

          cd "${FACTORY_IMAGE}"
          unzip -q "image-${FACTORY_IMAGE}.zip" vendor_boot.img
          mv vendor_boot.img ..
          cd ..

          ls -lah
          pwd

          android-kernel/tools/mkbootimg/unpack_bootimg.py --boot_img vendor_boot.img --out vendor_boot_out

          # Replace the vendor ramdisk artifact used by the build system
          cp -av vendor_boot_out/vendor-ramdisk-by-name/ramdisk_ \
            android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk-oriole.img

      - name: Compile Kernel
        shell: bash
        run: |
          set -euo pipefail
          set -x
          cd android-kernel
          BUILD_AOSP_KERNEL=1 ./build_slider.sh 2>&1 | tee /tmp/build.log


      - name: Pack images to upload
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p images

          cp -av android-kernel/out/slider/dist/boot.img images/
          cp -av android-kernel/out/slider/dist/dtbo.img images/
          cp -av android-kernel/out/slider/dist/vendor_boot.img images/
          cp -av android-kernel/out/slider/dist/vendor_dlkm.img images/

          cp -av flash-all.sh images/
          cp -av flash-all.bat images/

          zip -r images.zip images

      - name: Storage Check
        shell: bash
        run: |
          set -euo pipefail
          df -h
          cd android-kernel
          du -sh . || true

      - name: Upload files
        uses: actions/upload-artifact@v4
        with:
          name: the-images
          path: images.zip
