name: compile_from_source

on:
  workflow_dispatch:

concurrency:
  group: compile_from_source-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    env:
      DEVICE: oriole
      KERNEL_BRANCH: android14-gs-pixel-6.1
      MANIFEST_URL: https://android.googlesource.com/kernel/manifest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps + repo
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc \
            bison \
            build-essential \
            ca-certificates \
            ccache \
            clang \
            cpio \
            curl \
            file \
            flex \
            git \
            lld \
            llvm \
            libelf-dev \
            make \
            ninja-build \
            openssl \
            pahole \
            pkg-config \
            python3 \
            python3-pip \
            rsync \
            unzip \
            xz-utils \
            zstd \
            zip \
            binutils \
            binutils-dev \
            openjdk-17-jdk-headless

          sudo install -d -m 0755 /usr/local/bin
          sudo curl -fsSL -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod 0755 /usr/local/bin/repo
          /usr/local/bin/repo version

      - name: Cache repo + ccache
        uses: actions/cache@v4
        with:
          path: |
            android-kernel/.repo
            .ccache
          key: pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-${{ hashFiles('.github/workflows/compile_from_source.yml') }}
          restore-keys: |
            pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-

      - name: repo init + sync
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/android-kernel"
          cd "${GITHUB_WORKSPACE}/android-kernel"

          if [ ! -d ".repo" ]; then
            /usr/local/bin/repo init -u "${MANIFEST_URL}" -b "${KERNEL_BRANCH}"
          fi

          /usr/local/bin/repo sync \
            -c \
            -j"$(nproc)" \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --prune

      - name: Patch gki_defconfig (make it match savedefconfig)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          DEFCONFIG_PATH="$(find ./common -type f -path '*/arch/arm64/configs/gki_defconfig' -print -quit)"
          if [ -z "${DEFCONFIG_PATH}" ]; then
            echo "ERROR: gki_defconfig not found under ./common" >&2
            exit 1
          fi
          echo "Using defconfig: ${DEFCONFIG_PATH}"

          # Remove ONLY the lines that were causing the savedefconfig mismatch (if present).
          sed -i -E \
            -e '/^CONFIG_BT_HCI=y$/d' \
            -e '/^CONFIG_BT_HCIBTUSB=y$/d' \
            -e '/^CONFIG_USB=y$/d' \
            -e '/^CONFIG_USB_SUPPORT=y$/d' \
            "${DEFCONFIG_PATH}"

          # Ensure BT USB HCI driver is built as a module (this is what Kleaf is normalizing to).
          if grep -qE '^CONFIG_BT_HCIBTUSB=' "${DEFCONFIG_PATH}"; then
            sed -i -E 's/^CONFIG_BT_HCIBTUSB=.*/CONFIG_BT_HCIBTUSB=m/' "${DEFCONFIG_PATH}"
          else
            # Insert in the canonical spot (right after BT_HIDP) to match savedefconfig ordering.
            awk '
              BEGIN { inserted=0 }
              { print }
              /^CONFIG_BT_HIDP=/ && inserted==0 {
                print "CONFIG_BT_HCIBTUSB=m"
                inserted=1
              }
              END {
                if (inserted==0) print "CONFIG_BT_HCIBTUSB=m"
              }
            ' "${DEFCONFIG_PATH}" > "${DEFCONFIG_PATH}.tmp"
            mv "${DEFCONFIG_PATH}.tmp" "${DEFCONFIG_PATH}"
          fi

          echo "Patched BT section preview:"
          grep -nE 'CONFIG_BT_HIDP=|CONFIG_BT_HCIBTUSB=' "${DEFCONFIG_PATH}" || true

      - name: Prepare vendor ramdisk symlinks (optional; never fail)
        shell: bash
        run: |
          set -euo pipefail

          RAMDISK_DIR="${GITHUB_WORKSPACE}/android-kernel/prebuilts/boot-artifacts/ramdisks"
          mkdir -p "${RAMDISK_DIR}/vendor_ramdisk"

          if [ -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" ]; then
            cp -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" "${RAMDISK_DIR}/vendor_ramdisk-oriole.img"
            ln -sf "vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/oriole.img"
            ln -sf "../vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/vendor_ramdisk/oriole.img"
          fi

          /usr/bin/ls -al "${RAMDISK_DIR}" || true
          /usr/bin/ls -al "${RAMDISK_DIR}/vendor_ramdisk" || true

      - name: Build with Kleaf (public targets only)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          mkdir -p "${GITHUB_WORKSPACE}/.ccache"
          ccache --set-config=max_size=5.0G
          export USE_CCACHE=1
          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache"

          if [ ! -x "./tools/bazel" ]; then
            echo "ERROR: tools/bazel not found or not executable." >&2
            /usr/bin/ls -al ./tools >&2 || true
            exit 1
          fi

          BAZEL_USER_ROOT="/tmp/bazel_user_root_${GITHUB_RUN_ID}"
          BAZEL="./tools/bazel --output_user_root=${BAZEL_USER_ROOT}"
          echo "Using Bazel output_user_root: ${BAZEL_USER_ROOT}"

          pick="//common:kernel_aarch64_dist"
          echo "Chosen dist target: ${pick}"
          echo "${pick}" > "${GITHUB_WORKSPACE}/chosen_dist_target.txt"

          ${BAZEL} run "${pick}" 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"

      - name: Collect dist output
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/dist"

          mapfile -t dists < <(find "${GITHUB_WORKSPACE}/android-kernel" -maxdepth 8 -type d -name dist 2>/dev/null || true)
          for d in "${dists[@]}"; do
            rsync -a "${d}/." "${GITHUB_WORKSPACE}/dist/" || true
          done

          echo "dist contents:"
          /usr/bin/ls -al "${GITHUB_WORKSPACE}/dist" || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ env.DEVICE }}
          path: |
            dist/**
            build.log
            chosen_dist_target.txt
          if-no-files-found: warn
