name: Compile Kernel from Source (Pixel 6 / A14 / BT500)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/compile_from_source.yml"
      - "vendor_ramdisk00"
      - "flash-all.bat"
      - "flash-all.sh"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      FACTORY_IMAGE: oriole-ap2a.240905.003.f1
      FACTORY_ZIP_URL: https://dl.google.com/dl/android/aosp/oriole-ap2a.240905.003.f1-factory-655c44e7.zip

    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Free up space
        uses: jlumbroso/free-disk-space@main

      - name: Install packages
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            repo git curl unzip zip python3 \
            build-essential gcc g++ \
            bc bison flex rsync \
            libssl-dev libelf-dev dwarves \
            ca-certificates

      - name: Sync kernel repo (Pixel 6 raviole 5.10 Android 14)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p android-kernel
          cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b android-gs-raviole-5.10-android14
          export REPO="$(pwd)/.repo/repo/repo"
          "${REPO}" sync -c --no-tags -j4 --fail-fast --force-sync --no-clone-bundle

      - name: Force-enable BT USB (ASUS BT500) in defconfig
        shell: bash
        run: |
          set -euo pipefail
          cd android-kernel

          DEF="$(find . -type f -name gki_defconfig | head -n 1)"
          if [ -z "${DEF}" ]; then
            echo "ERROR: gki_defconfig not found" >&2
            exit 1
          fi

          echo "[+] Using defconfig: ${DEF}"
          cp -av "${DEF}" "${DEF}.bak"

          grep -q '^CONFIG_BT=' "${DEF}" || echo 'CONFIG_BT=y' >> "${DEF}"
          grep -q '^CONFIG_BT_HCI=' "${DEF}" || echo 'CONFIG_BT_HCI=y' >> "${DEF}"
          grep -q '^CONFIG_BT_RFCOMM=' "${DEF}" || echo 'CONFIG_BT_RFCOMM=y' >> "${DEF}"
          grep -q '^CONFIG_BT_HCIBTUSB=' "${DEF}" || echo 'CONFIG_BT_HCIBTUSB=y' >> "${DEF}"

          grep -q '^CONFIG_USB=' "${DEF}" || echo 'CONFIG_USB=y' >> "${DEF}"
          grep -q '^CONFIG_USB_SUPPORT=' "${DEF}" || echo 'CONFIG_USB_SUPPORT=y' >> "${DEF}"

          echo "----- tail ${DEF} -----"
          tail -n 80 "${DEF}"

      - name: Update vendor ramdisk (from factory zip)
        shell: bash
        run: |
          set -euo pipefail

          # Download factory image
          curl -fL -o factory.zip "${FACTORY_ZIP_URL}"
          unzip -q factory.zip

          # Extract vendor_boot.img
          cd "${FACTORY_IMAGE}"
          unzip -q "image-${FACTORY_IMAGE}.zip" vendor_boot.img
          mv vendor_boot.img ..
          cd ..

          # Unpack vendor_boot.img to get vendor ramdisk payload
          android-kernel/tools/mkbootimg/unpack_bootimg.py --boot_img vendor_boot.img --out vendor_boot_out

          RAMDISK_SRC="vendor_boot_out/vendor-ramdisk-by-name/ramdisk_"
          if [ ! -f "${RAMDISK_SRC}" ]; then
            echo "ERROR: vendor ramdisk not found at ${RAMDISK_SRC}" >&2
            find vendor_boot_out -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          # Put the ramdisk where different scripts expect it
          mkdir -p android-kernel/prebuilts/boot-artifacts/ramdisks
          mkdir -p android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk

          cp -av "${RAMDISK_SRC}" android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk-oriole.img
          cp -av "${RAMDISK_SRC}" android-kernel/prebuilts/boot-artifacts/ramdisks/oriole.img || true
          cp -av "${RAMDISK_SRC}" android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk/oriole.img || true

          ls -lah android-kernel/prebuilts/boot-artifacts/ramdisks || true

      - name: Sanity check vendor ramdisk exists
        shell: bash
        run: |
          set -euo pipefail
          ls -lah android-kernel/prebuilts/boot-artifacts/ramdisks || true
          test -f android-kernel/prebuilts/boot-artifacts/ramdisks/vendor_ramdisk-oriole.img

      - name: Compile Kernel (build_slider.sh) + fix __isoc23_* host link errors
        shell: bash
        run: |
          set -euo pipefail
          set -x
          cd android-kernel

          # Force host tools (resolve_btfids) to build with GCC and avoid C23 __isoc23_* symbols
          export HOSTCC=gcc
          export HOSTCXX=g++
          export HOSTCFLAGS="-std=gnu11"
          export HOSTCXXFLAGS="-std=gnu++17"

          BUILD_AOSP_KERNEL=1 ./build_slider.sh 2>&1 | tee /tmp/build.log

      - name: Pack images to upload
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p images

          cp -av android-kernel/out/slider/dist/boot.img images/
          cp -av android-kernel/out/slider/dist/dtbo.img images/
          cp -av android-kernel/out/slider/dist/vendor_boot.img images/
          cp -av android-kernel/out/slider/dist/vendor_dlkm.img images/

          cp -av flash-all.sh images/ || true
          cp -av flash-all.bat images/ || true

          zip -r images.zip images

      - name: Upload files
        uses: actions/upload-artifact@v4
        with:
          name: the-images
          path: images.zip
