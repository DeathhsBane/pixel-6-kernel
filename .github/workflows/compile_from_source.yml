name: compile_from_source

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - ".github/workflows/compile_from_source.yml"
      - "vendor_ramdisk00"
      - "build_kali_nethunter.sh"
      - "util_functions.sh"

concurrency:
  group: compile-from-source-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    env:
      DEVICE: oriole
      KERNEL_BRANCH: android14-gs-pixel-6.1
      KERNEL_TOP: ${{ github.workspace }}/android-kernel
      RAMDISK_DIR: ${{ github.workspace }}/android-kernel/prebuilts/boot-artifacts/ramdisks

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanity check repo contents
        shell: bash
        run: |
          set -euo pipefail
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE}"
          /usr/bin/ls -al "${GITHUB_WORKSPACE}"

          test -f "${GITHUB_WORKSPACE}/vendor_ramdisk00"

          if [ ! -f "${GITHUB_WORKSPACE}/build_kali_nethunter.sh" ]; then
            echo "ERROR: Missing build_kali_nethunter.sh at repo root." >&2
            exit 1
          fi

      - name: Install build deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ca-certificates clang cpio curl flex file git \
            lld llvm lz4 make ninja-build openssl pahole pkg-config python3 python3-pip \
            rsync unzip xz-utils zstd \
            binutils binutils-dev libelf-dev libncurses-dev libssl-dev ccache

          command -v /usr/bin/ld.bfd >/dev/null 2>&1 || (echo "ERROR: /usr/bin/ld.bfd missing" >&2; exit 1)

      - name: Install repo tool
        shell: bash
        run: |
          set -euo pipefail
          sudo install -d -m 0755 /usr/local/bin
          sudo curl -fsSL -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod 0755 /usr/local/bin/repo
          /usr/local/bin/repo version

      - name: Cache repo + out + ccache (best-effort)
        continue-on-error: true
        uses: actions/cache@v4
        with:
          path: |
            android-kernel/.repo
            android-kernel/out
            .ccache
          key: pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-${{ github.ref_name }}-
            pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-

      - name: repo init + sync (creates android-kernel/)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${KERNEL_TOP}"
          cd "${KERNEL_TOP}"

          if [ ! -d ".repo" ]; then
            /usr/local/bin/repo init \
              -u https://android.googlesource.com/kernel/manifest \
              -b "${KERNEL_BRANCH}" \
              --depth=1
          fi

          /usr/local/bin/repo sync \
            -c \
            -j"$(nproc)" \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --prune

      - name: Find + patch gki_defconfig (no ./aosp assumption)
        shell: bash
        run: |
          set -euo pipefail
          cd "${KERNEL_TOP}"

          DEFCONFIG_PATH="$(find ./common ./aosp -type f -path "*/arch/arm64/configs/gki_defconfig" -print -quit 2>/dev/null || true)"
          if [ -z "${DEFCONFIG_PATH}" ]; then
            echo "ERROR: gki_defconfig not found under ./common or ./aosp" >&2
            find . -maxdepth 10 -type f -name "gki_defconfig" -print 2>/dev/null || true
            exit 1
          fi
          echo "Using defconfig: ${DEFCONFIG_PATH}"

          for line in \
            "CONFIG_BT_HCI=y" \
            "CONFIG_BT_HCIBTUSB=y" \
            "CONFIG_USB=y" \
            "CONFIG_USB_SUPPORT=y"
          do
            grep -qxF "${line}" "${DEFCONFIG_PATH}" || echo "${line}" >> "${DEFCONFIG_PATH}"
          done

          tail -n 40 "${DEFCONFIG_PATH}"

      - name: Provide vendor ramdisk (from repo root vendor_ramdisk00)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${RAMDISK_DIR}/vendor_ramdisk"

          cp -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" "${RAMDISK_DIR}/vendor_ramdisk-oriole.img"
          ln -sf "vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/oriole.img"
          ln -sf "../vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/vendor_ramdisk/oriole.img"

          /usr/bin/ls -al "${RAMDISK_DIR}"
          /usr/bin/ls -al "${RAMDISK_DIR}/vendor_ramdisk"

          test -f "${RAMDISK_DIR}/vendor_ramdisk-oriole.img"
          test -e "${RAMDISK_DIR}/oriole.img"
          test -e "${RAMDISK_DIR}/vendor_ramdisk/oriole.img"

      - name: Discover possible build entrypoints (debug helper)
        shell: bash
        run: |
          set -euo pipefail
          echo "Repo-root scripts:"
          /usr/bin/ls -al "${GITHUB_WORKSPACE}" | sed -n '1,200p'
          echo ""
          echo "Kernel-top scripts:"
          /usr/bin/find "${KERNEL_TOP}" -maxdepth 3 -type f -name "*.sh" -print 2>/dev/null | sed -n '1,200p' || true
          echo ""
          echo "Kernel-top build configs:"
          /usr/bin/find "${KERNEL_TOP}" -maxdepth 4 -type f -name "build.config*" -print 2>/dev/null | sed -n '1,200p' || true

      - name: Build (always use your repo-root script)
        shell: bash
        run: |
          set -euo pipefail

          export HOSTCC=/usr/bin/gcc
          export HOSTCXX=/usr/bin/g++
          export HOSTLD=/usr/bin/ld.bfd
          export HOSTCFLAGS="-std=gnu11"
          export HOSTCXXFLAGS="-std=gnu++17"

          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache"
          mkdir -p "${CCACHE_DIR}"
          ccache -M 5G || true
          ccache -z || true

          chmod +x "${GITHUB_WORKSPACE}/build_kali_nethunter.sh" || true
          /usr/bin/bash -x "${GITHUB_WORKSPACE}/build_kali_nethunter.sh" | tee "${GITHUB_WORKSPACE}/build.log"

          ccache -s || true

      - name: Collect outputs (never fails)
        if: always()
        shell: bash
        run: |
          set -u
          echo "dist candidates:"
          /usr/bin/find "${KERNEL_TOP}/out" -maxdepth 8 -type d -name dist -print 2>/dev/null || true
          echo ""
          echo "out tree (top):"
          /usr/bin/ls -al "${KERNEL_TOP}/out" 2>/dev/null || true
          echo ""
          echo "last 200 lines build.log:"
          /usr/bin/tail -n 200 "${GITHUB_WORKSPACE}/build.log" 2>/dev/null || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oriole-build
          path: |
            android-kernel/out/**/dist/**
            android-kernel/out/**
            build.log
          if-no-files-found: warn
