name: compile_from_source

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - ".github/workflows/compile_from_source.yml"

concurrency:
  group: compile_from_source-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    env:
      KERNEL_BRANCH: android14-gs-pixel-6.1
      DEVICE: oriole
      KERNEL_DIR: android-kernel
      MANIFEST_URL: https://android.googlesource.com/kernel/manifest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc \
            bison \
            build-essential \
            ca-certificates \
            ccache \
            clang \
            cpio \
            curl \
            flex \
            file \
            git \
            libelf-dev \
            libncurses-dev \
            libssl-dev \
            lld \
            llvm \
            lz4 \
            make \
            ninja-build \
            openssl \
            pahole \
            pkg-config \
            python3 \
            python3-pip \
            rsync \
            unzip \
            xz-utils \
            zstd
          clang --version
          ld.lld --version || true
          /usr/bin/ccache -V || true

      - name: Install repo tool
        shell: bash
        run: |
          set -euo pipefail
          sudo install -d -m 0755 /usr/local/bin
          sudo curl -fsSL -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod 0755 /usr/local/bin/repo
          /usr/local/bin/repo version

      - name: Cache repo checkout
        uses: actions/cache@v4
        with:
          path: |
            android-kernel/.repo
          key: repo-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-${{ hashFiles('.github/workflows/compile_from_source.yml') }}
          restore-keys: |
            repo-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-

      - name: repo init + sync
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "${KERNEL_DIR}"
          cd "${KERNEL_DIR}"

          if [ ! -d ".repo" ]; then
            /usr/local/bin/repo init -u "${MANIFEST_URL}" -b "${KERNEL_BRANCH}"
          fi

          /usr/local/bin/repo sync \
            -c \
            -j"$(nproc)" \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --prune

      - name: Patch gki_defconfig (BT USB)
        shell: bash
        run: |
          set -euo pipefail
          cd "${KERNEL_DIR}"

          DEFCONFIG_PATH="./common/arch/arm64/configs/gki_defconfig"
          if [ ! -f "${DEFCONFIG_PATH}" ]; then
            echo "ERROR: expected defconfig not found: ${DEFCONFIG_PATH}" >&2
            /usr/bin/find . -maxdepth 5 -name "gki_defconfig" -print || true
            exit 1
          fi

          append_once () {
            local line="$1"
            local file="$2"
            if ! /usr/bin/grep -qxF "${line}" "${file}"; then
              echo "${line}" >> "${file}"
            fi
          }

          echo "" >> "${DEFCONFIG_PATH}"
          append_once "CONFIG_BT=y" "${DEFCONFIG_PATH}"
          append_once "CONFIG_BT_HCI=y" "${DEFCONFIG_PATH}"
          append_once "CONFIG_BT_HCIBTUSB=y" "${DEFCONFIG_PATH}"
          append_once "CONFIG_USB=y" "${DEFCONFIG_PATH}"
          append_once "CONFIG_USB_SUPPORT=y" "${DEFCONFIG_PATH}"

          echo "Patched tail:"
          /usr/bin/tail -n 40 "${DEFCONFIG_PATH}"

      - name: Build (Bazel/Kleaf)
        shell: bash
        run: |
          set -euo pipefail
          cd "${KERNEL_DIR}"

          if [ ! -x "./tools/bazel" ]; then
            echo "ERROR: ./tools/bazel not found or not executable." >&2
            echo "This tree should support Bazel/Kleaf for Android 14+." >&2
            exit 1
          fi

          TARGET="//gs/google-modules/soc-modules:slider_dist"
          if ! ./tools/bazel query "${TARGET}" >/dev/null 2>&1; then
            echo "WARN: ${TARGET} not found; falling back to //common:kernel_aarch64_dist" >&2
            TARGET="//common:kernel_aarch64_dist"
          fi

          echo "Using Bazel target: ${TARGET}"
          ./tools/bazel run "${TARGET}" 2>&1 | /usr/bin/tee /tmp/kernel-build.log

          echo "Searching for dist dir..."
          DIST_DIR="$(/usr/bin/find out -maxdepth 4 -type d -name dist -print -quit || true)"
          if [ -z "${DIST_DIR}" ]; then
            echo "ERROR: dist dir not found under ${KERNEL_DIR}/out" >&2
            /usr/bin/find out -maxdepth 6 -type d -print | /usr/bin/head -n 200 || true
            exit 1
          fi

          echo "DIST_DIR=${DIST_DIR}" >> "${GITHUB_ENV}"
          echo "Dist dir: ${DIST_DIR}"
          /usr/bin/ls -al "${DIST_DIR}" || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-dist-${{ env.DEVICE }}
          path: |
            android-kernel/${{ env.DIST_DIR }}/**
            /tmp/kernel-build.log
          if-no-files-found: warn
