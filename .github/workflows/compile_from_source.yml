name: compile_from_source

on:
  workflow_dispatch:

concurrency:
  group: compile_from_source-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    env:
      DEVICE: oriole
      KERNEL_BRANCH: android14-gs-pixel-6.1
      MANIFEST_URL: https://android.googlesource.com/kernel/manifest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps + repo
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc \
            bison \
            build-essential \
            ca-certificates \
            ccache \
            clang \
            cpio \
            curl \
            file \
            flex \
            git \
            lld \
            llvm \
            libelf-dev \
            make \
            ninja-build \
            openssl \
            pahole \
            pkg-config \
            python3 \
            python3-pip \
            rsync \
            unzip \
            xz-utils \
            zstd \
            binutils \
            binutils-dev

          sudo install -d -m 0755 /usr/local/bin
          sudo curl -fsSL -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod 0755 /usr/local/bin/repo
          /usr/local/bin/repo version

      - name: Cache repo + out + ccache
        uses: actions/cache@v4
        with:
          path: |
            android-kernel/.repo
            android-kernel/out
            .ccache
          key: pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-${{ hashFiles('.github/workflows/compile_from_source.yml') }}
          restore-keys: |
            pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-

      - name: repo init + sync
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/android-kernel"
          cd "${GITHUB_WORKSPACE}/android-kernel"

          if [ ! -d ".repo" ]; then
            /usr/local/bin/repo init -u "${MANIFEST_URL}" -b "${KERNEL_BRANCH}"
          fi

          /usr/local/bin/repo sync \
            -c \
            -j"$(nproc)" \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --prune

      - name: Patch gki_defconfig (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          DEFCONFIG_PATH="$(find ./common -type f -path '*/arch/arm64/configs/gki_defconfig' -print -quit)"
          if [ -z "${DEFCONFIG_PATH}" ]; then
            echo "ERROR: gki_defconfig not found under ./common" >&2
            exit 1
          fi
          echo "Using defconfig: ${DEFCONFIG_PATH}"

          ensure() {
            local key="$1" val="$2" f="$3"
            if grep -qE "^${key}=" "$f"; then
              sed -i "s/^${key}=.*/${key}=${val}/" "$f"
            else
              printf '%s=%s\n' "$key" "$val" >> "$f"
            fi
          }

          ensure CONFIG_BT_HCI y "${DEFCONFIG_PATH}"
          ensure CONFIG_BT_HCIBTUSB y "${DEFCONFIG_PATH}"
          ensure CONFIG_USB y "${DEFCONFIG_PATH}"
          ensure CONFIG_USB_SUPPORT y "${DEFCONFIG_PATH}"

          tail -n 40 "${DEFCONFIG_PATH}"

      - name: Prepare vendor ramdisk symlinks
        shell: bash
        run: |
          set -euo pipefail

          RAMDISK_DIR="${GITHUB_WORKSPACE}/android-kernel/prebuilts/boot-artifacts/ramdisks"
          mkdir -p "${RAMDISK_DIR}/vendor_ramdisk"

          if [ -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" ]; then
            cp -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" "${RAMDISK_DIR}/vendor_ramdisk-oriole.img"
          elif [ -f "${RAMDISK_DIR}/vendor_ramdisk-oriole.img" ]; then
            echo "Using existing ${RAMDISK_DIR}/vendor_ramdisk-oriole.img"
          else
            echo "ERROR: missing vendor ramdisk source. Put vendor_ramdisk00 at repo root." >&2
            exit 1
          fi

          ln -sf "vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/oriole.img"
          ln -sf "../vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/vendor_ramdisk/oriole.img"

          /usr/bin/ls -al "${RAMDISK_DIR}"
          /usr/bin/ls -al "${RAMDISK_DIR}/vendor_ramdisk"

      - name: Build kernel (build/build.sh)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          mkdir -p "${GITHUB_WORKSPACE}/.ccache"
          ccache --set-config=max_size=5.0G
          export USE_CCACHE=1
          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache"

          # Your current failure is here: build/build.sh is missing or not executable in your synced tree.
          # Fix: if missing, pull kernel/build and fill in missing top-level build scripts.
          if [ ! -f "./build/build.sh" ]; then
            echo "build/build.sh missing; pulling kernel/build to supply it..."
            rm -rf /tmp/kernel-build
            GIT_TERMINAL_PROMPT=0 git clone --depth=1 https://android.googlesource.com/kernel/build /tmp/kernel-build
            mkdir -p ./build
            rsync -a --ignore-existing /tmp/kernel-build/ ./build/
          fi

          if [ ! -f "./build/build.sh" ]; then
            echo "ERROR: still no build/build.sh after fallback." >&2
            echo "Contents of ./build:" >&2
            /usr/bin/ls -al ./build >&2 || true
            exit 1
          fi

          if [ -f "./private/gs-google/build.config.slider" ]; then
            export BUILD_CONFIG=private/gs-google/build.config.slider
          elif [ -f "./common/build.config.gki.aarch64" ]; then
            export BUILD_CONFIG=common/build.config.gki.aarch64
          elif [ -f "./common/build.config.gki" ]; then
            export BUILD_CONFIG=common/build.config.gki
          else
            echo "ERROR: no known BUILD_CONFIG found." >&2
            find . -maxdepth 4 -type f -name "build.config*" -print | head -n 200 || true
            exit 1
          fi

          export OUT_DIR="${GITHUB_WORKSPACE}/android-kernel/out"
          export DIST_DIR="${GITHUB_WORKSPACE}/dist"
          mkdir -p "${DIST_DIR}"

          bash ./build/build.sh 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ env.DEVICE }}
          path: |
            dist/**
            build.log
          if-no-files-found: warn
