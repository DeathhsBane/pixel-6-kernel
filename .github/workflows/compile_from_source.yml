name: compile_from_source

on:
  workflow_dispatch:

concurrency:
  group: compile_from_source-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    env:
      DEVICE: oriole
      KERNEL_BRANCH: android14-gs-pixel-6.1
      MANIFEST_URL: https://android.googlesource.com/kernel/manifest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps + repo
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc \
            bison \
            build-essential \
            ca-certificates \
            ccache \
            clang \
            cpio \
            curl \
            file \
            flex \
            git \
            lld \
            llvm \
            libelf-dev \
            make \
            ninja-build \
            openssl \
            pahole \
            pkg-config \
            python3 \
            python3-pip \
            rsync \
            unzip \
            xz-utils \
            zstd \
            binutils \
            binutils-dev

          sudo install -d -m 0755 /usr/local/bin
          sudo curl -fsSL -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod 0755 /usr/local/bin/repo
          /usr/local/bin/repo version

      - name: Cache repo + out + ccache
        uses: actions/cache@v4
        with:
          path: |
            android-kernel/.repo
            android-kernel/out
            .ccache
          key: pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-${{ hashFiles('.github/workflows/compile_from_source.yml') }}
          restore-keys: |
            pixel6-${{ runner.os }}-${{ env.KERNEL_BRANCH }}-

      - name: repo init + sync
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/android-kernel"
          cd "${GITHUB_WORKSPACE}/android-kernel"

          if [ ! -d ".repo" ]; then
            /usr/local/bin/repo init -u "${MANIFEST_URL}" -b "${KERNEL_BRANCH}"
          fi

          /usr/local/bin/repo sync \
            -c \
            -j"$(nproc)" \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --prune

      - name: Patch gki_defconfig (savedefconfig-friendly)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          DEFCONFIG_PATH="./common/arch/arm64/configs/gki_defconfig"
          test -f "${DEFCONFIG_PATH}"

          # Kleaf/savedefconfig expects this as a module and in the sorted section
          if grep -q '^CONFIG_BT_HCIBTUSB=' "${DEFCONFIG_PATH}"; then
            sed -i 's/^CONFIG_BT_HCIBTUSB=.*/CONFIG_BT_HCIBTUSB=m/' "${DEFCONFIG_PATH}"
          else
            # Insert where savedefconfig places it (right after BT_HIDP)
            if grep -q '^CONFIG_BT_HIDP=m$' "${DEFCONFIG_PATH}"; then
              sed -i '/^CONFIG_BT_HIDP=m$/a CONFIG_BT_HCIBTUSB=m' "${DEFCONFIG_PATH}"
            else
              # Fallback (shouldn't happen, but won't break YAML)
              echo 'CONFIG_BT_HCIBTUSB=m' >> "${DEFCONFIG_PATH}"
            fi
          fi

          echo "Defconfig snippet:"
          grep -n -E '^CONFIG_BT_(HIDP|HCIBTUSB)=' "${DEFCONFIG_PATH}" || true

      - name: Patch Kleaf module_outs for btusb modules
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          python3 - <<'PY'
          from pathlib import Path

          p = Path("common/BUILD.bazel")
          s = p.read_text()

          anchor = 'name = "kernel_aarch64"'
          i = s.find(anchor)
          if i == -1:
            raise SystemExit("ERROR: kernel_aarch64 target not found in common/BUILD.bazel")

          mo = s.find("module_outs", i)
          if mo == -1:
            raise SystemExit("ERROR: module_outs not found under kernel_aarch64 (unexpected for your tree)")

          lb = s.find("[", mo)
          if lb == -1:
            raise SystemExit("ERROR: module_outs list '[' not found")

          depth = 0
          rb = None
          for k in range(lb, len(s)):
            if s[k] == "[":
              depth += 1
            elif s[k] == "]":
              depth -= 1
              if depth == 0:
                rb = k
                break
          if rb is None:
            raise SystemExit("ERROR: could not find end of module_outs list")

          block = s[lb+1:rb]
          want = [
            "drivers/bluetooth/btusb.ko",
            "drivers/bluetooth/btrtl.ko",
            "drivers/bluetooth/btintel.ko",
          ]

          # Detect indentation from existing entries
          import re
          m = re.search(r"\n(\s*)\"", block)
          indent = m.group(1) if m else "    "

          missing = [w for w in want if (f'"{w}"' not in block)]
          if not missing:
            print("module_outs already contains btusb/btrtl/btintel")
            raise SystemExit(0)

          insert = "".join([f'\n{indent}"{w}",' for w in missing])
          new_block = block.rstrip() + insert + "\n"
          s2 = s[:lb+1] + new_block + s[rb:]

          p.write_text(s2)
          print("Added to module_outs:", ", ".join(missing))
          PY

          echo "Patched lines (grep):"
          grep -n -E 'btusb\.ko|btrtl\.ko|btintel\.ko' common/BUILD.bazel || true

      - name: Prepare vendor ramdisk symlinks (optional, keeps your tree happy)
        shell: bash
        run: |
          set -euo pipefail
          RAMDISK_DIR="${GITHUB_WORKSPACE}/android-kernel/prebuilts/boot-artifacts/ramdisks"
          mkdir -p "${RAMDISK_DIR}/vendor_ramdisk"

          if [ -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" ]; then
            cp -f "${GITHUB_WORKSPACE}/vendor_ramdisk00" "${RAMDISK_DIR}/vendor_ramdisk-oriole.img"
          elif [ -f "${RAMDISK_DIR}/vendor_ramdisk-oriole.img" ]; then
            echo "Using existing ${RAMDISK_DIR}/vendor_ramdisk-oriole.img"
          else
            echo "WARN: vendor_ramdisk00 not present; continuing (not required for //common dist)"
          fi

          ln -sf "vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/oriole.img"
          ln -sf "../vendor_ramdisk-oriole.img" "${RAMDISK_DIR}/vendor_ramdisk/oriole.img" || true

          /usr/bin/ls -al "${RAMDISK_DIR}" || true
          /usr/bin/ls -al "${RAMDISK_DIR}/vendor_ramdisk" || true

      - name: Build dist (Kleaf Bazel)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/android-kernel"

          mkdir -p "${GITHUB_WORKSPACE}/.ccache"
          ccache --set-config=max_size=5.0G
          export USE_CCACHE=1
          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache"

          rm -rf "${GITHUB_WORKSPACE}/dist"
          mkdir -p "${GITHUB_WORKSPACE}/dist"

          # Use a temp output_user_root to avoid weird cached toolchain states
          export BAZEL_OUTPUT_USER_ROOT="/tmp/bazel_user_root_${GITHUB_RUN_ID}"

          if [ -x "./tools/bazel" ]; then
            BAZEL="./tools/bazel"
          else
            echo "ERROR: ./tools/bazel not found/executable" >&2
            exit 1
          fi

          "${BAZEL}" run //common:kernel_aarch64_dist -- --dist_dir="${GITHUB_WORKSPACE}/dist" 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ env.DEVICE }}
          path: |
            dist/**
            build.log
          if-no-files-found: warn
